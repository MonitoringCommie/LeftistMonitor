<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LeftistMonitor - Interactive 3D Globe</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 100%;
      height: 100vh;
      background: #2a1a1a;
      font-family: 'Georgia', 'Times New Roman', serif;
      color: #fff;
      overflow: hidden;
      touch-action: none;
    }

    canvas {
      display: block;
      touch-action: none;
    }

    .container {
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* Title */
    .title {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 100;
      pointer-events: none;
    }

    .title h1 {
      font-size: 28px;
      font-weight: 900;
      margin: 0;
      color: #fff;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .title h1::before { content: "\2606 "; color: #D4A017; }
    .title h1::after { content: " \2606"; color: #D4A017; }

    .title p {
      font-size: 12px;
      color: #D4A017;
      margin: 4px 0 0 0;
      font-style: italic;
    }

    /* Top right controls */
    .controls-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
      background: rgba(139, 26, 26, 0.88);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(212, 160, 23, 0.4);
      border-radius: 10px;
      padding: 16px;
      min-width: 200px;
    }

    .controls-panel h3 {
      font-size: 12px;
      text-transform: uppercase;
      color: #D4A017;
      margin-bottom: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .control-group {
      margin-bottom: 12px;
    }

    .control-group:last-child {
      margin-bottom: 0;
    }

    .toggle-btn {
      display: inline-block;
      width: 100%;
      padding: 8px 12px;
      background: rgba(221, 68, 68, 0.1);
      border: 1px solid rgba(221, 68, 68, 0.4);
      color: #F5DEB3;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .toggle-btn:hover {
      background: rgba(221, 68, 68, 0.2);
      border-color: rgba(221, 68, 68, 0.6);
    }

    .toggle-btn.active {
      background: rgba(221, 68, 68, 0.3);
      border-color: #D4A017;
      color: #fff;
    }

    /* Liberation struggles panel */
    .liberation-panel {
      position: fixed;
      top: 320px;
      right: 20px;
      z-index: 100;
      background: rgba(139, 26, 26, 0.88);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(102, 204, 102, 0.25);
      border-radius: 10px;
      padding: 12px;
      max-width: 220px;
      max-height: 300px;
      overflow-y: auto;
    }

    .liberation-panel h3 {
      font-size: 11px;
      text-transform: uppercase;
      color: #6c6;
      margin-bottom: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .liberation-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(102, 204, 102, 0.1);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .liberation-item:last-child {
      border-bottom: none;
    }

    .liberation-item:hover {
      color: #6c6;
    }

    .liberation-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      flex-shrink: 0;
    }

    /* Bottom left: Active conflicts list */
    .conflicts-panel {
      position: fixed;
      bottom: 180px;
      left: 20px;
      z-index: 100;
      background: rgba(139, 26, 26, 0.88);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(212, 160, 23, 0.4);
      border-radius: 10px;
      padding: 12px;
      max-width: 240px;
      max-height: 350px;
      overflow-y: auto;
    }

    .conflicts-panel h3 {
      font-size: 11px;
      text-transform: uppercase;
      color: #E8485C;
      margin-bottom: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .conflict-item {
      display: flex;
      align-items: flex-start;
      padding: 8px 0;
      border-bottom: 1px solid rgba(221, 68, 68, 0.1);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .conflict-item:last-child {
      border-bottom: none;
    }

    .conflict-item:hover {
      color: #F5DEB3;
    }

    .conflict-item.active {
      background: rgba(221, 68, 68, 0.15);
      border-radius: 4px;
      padding: 8px 6px;
      margin: 4px -6px;
    }

    .conflict-dots {
      display: flex;
      gap: 4px;
      margin-right: 8px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .conflict-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .conflict-info {
      flex: 1;
    }

    .conflict-name {
      font-weight: 500;
      color: #fff;
    }

    .conflict-years {
      font-size: 10px;
      color: #888;
      margin-top: 2px;
    }

    /* Bottom center: Time slider */
    .time-slider-panel {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      background: rgba(139, 26, 26, 0.88);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(212, 160, 23, 0.4);
      border-radius: 10px;
      padding: 16px 24px;
      min-width: 400px;
      text-align: center;
    }

    .time-slider-panel h3 {
      font-size: 11px;
      text-transform: uppercase;
      color: #D4A017;
      margin-bottom: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .play-pause-btn {
      width: 32px;
      height: 32px;
      background: rgba(221, 68, 68, 0.1);
      border: 1px solid rgba(221, 68, 68, 0.4);
      color: #F5DEB3;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .play-pause-btn:hover {
      background: rgba(221, 68, 68, 0.2);
      border-color: rgba(221, 68, 68, 0.6);
    }

    .time-slider {
      flex: 1;
      height: 4px;
      background: rgba(221, 68, 68, 0.2);
      border-radius: 2px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .time-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: #C41E3A;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(196, 30, 58, 0.5);
    }

    .time-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: #C41E3A;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 8px rgba(196, 30, 58, 0.5);
    }

    .year-display {
      font-size: 18px;
      font-weight: 700;
      color: #D4A017;
      min-width: 60px;
      text-align: right;
    }

    .conflict-count {
      font-size: 11px;
      color: #888;
      margin-top: 8px;
    }

    /* Legend */
    .legend {
      position: fixed;
      bottom: 65px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 99;
      font-size: 11px;
      color: #888;
      text-align: center;
    }

    /* Detail panel (conflict info) */
    .detail-panel {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 101;
      background: rgba(139, 26, 26, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(212, 160, 23, 0.4);
      border-radius: 10px;
      padding: 20px;
      max-width: 300px;
      max-height: 80vh;
      overflow-y: auto;
      display: none;
    }

    .detail-panel.active {
      display: block;
    }

    .detail-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: #888;
      font-size: 20px;
      cursor: pointer;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .detail-close:hover {
      color: #fff;
    }

    .detail-title {
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 12px;
      padding-right: 24px;
    }

    .detail-meta {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 12px;
      color: #F5DEB3;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(221, 68, 68, 0.2);
    }

    .detail-section-title {
      font-size: 11px;
      text-transform: uppercase;
      color: #D4A017;
      margin-top: 12px;
      margin-bottom: 8px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .detail-side {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .detail-side-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .detail-side-text {
      flex: 1;
    }

    .detail-side-name {
      font-weight: 500;
      color: #fff;
    }

    .detail-side-countries {
      font-size: 10px;
      color: #888;
      margin-top: 2px;
    }

    .detail-description {
      font-size: 11px;
      line-height: 1.5;
      color: #F5DEB3;
      margin-top: 12px;
    }

    /* Country info panel */
    .country-panel {
      position: fixed;
      right: 20px;
      bottom: 120px;
      z-index: 101;
      background: rgba(139, 26, 26, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(212, 160, 23, 0.4);
      border-radius: 10px;
      padding: 16px;
      max-width: 280px;
      display: none;
    }

    .country-panel.active {
      display: block;
    }

    .country-panel h2 {
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 12px 0;
      color: #fff;
    }

    .country-btn {
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      background: rgba(221, 68, 68, 0.2);
      border: 1px solid rgba(221, 68, 68, 0.4);
      color: #F5DEB3;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      text-decoration: none;
    }

    .country-btn:hover {
      background: rgba(221, 68, 68, 0.3);
      border-color: rgba(221, 68, 68, 0.6);
    }

    .country-close {
      float: right;
      background: none;
      border: none;
      color: #888;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
    }

    .country-close:hover {
      color: #fff;
    }

    /* Scrollbar styling */
    .conflicts-panel::-webkit-scrollbar,
    .liberation-panel::-webkit-scrollbar,
    .detail-panel::-webkit-scrollbar {
      width: 6px;
    }

    .conflicts-panel::-webkit-scrollbar-track,
    .liberation-panel::-webkit-scrollbar-track,
    .detail-panel::-webkit-scrollbar-track {
      background: rgba(221, 68, 68, 0.05);
      border-radius: 3px;
    }

    .conflicts-panel::-webkit-scrollbar-thumb,
    .liberation-panel::-webkit-scrollbar-thumb,
    .detail-panel::-webkit-scrollbar-thumb {
      background: rgba(221, 68, 68, 0.3);
      border-radius: 3px;
    }

    .conflicts-panel::-webkit-scrollbar-thumb:hover,
    .liberation-panel::-webkit-scrollbar-thumb:hover,
    .detail-panel::-webkit-scrollbar-thumb:hover {
      background: rgba(221, 68, 68, 0.5);
    }
    /* Monitoring dashboard enhancements */
    @keyframes pulse-live {
      0%, 100% { opacity: 1; box-shadow: 0 0 4px #dd4444; }
      50% { opacity: 0.4; box-shadow: 0 0 12px #dd4444; }
    }

    @keyframes pulse-conflict {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.5); opacity: 0.3; }
    }

    .title h1 {
      font-size: 24px;
      font-weight: 900;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .title p {
      color: #dd6666;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: 500;
    }

    /* Status bar at top */
    .status-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #dd4444 0%, transparent 30%, #dd4444 50%, transparent 70%, #dd4444 100%);
      z-index: 200;
      opacity: 0.6;
    }

    /* Panel borders glow effect */
    .controls-panel,
    .conflicts-panel,
    .liberation-panel,
    .time-slider-panel,
    .detail-panel,
    .country-panel {
      box-shadow: 0 4px 24px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.03);
    }

    /* Active conflict count badge */
    .conflict-count {
      color: #dd6666;
      font-weight: 500;
    }

    .conflicts-panel h3::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #C41E3A;
      margin-right: 6px;
      animation: pulse-live 2s infinite;
    }

    /* Liberation panel green accent */
    .liberation-panel {
      border-color: rgba(68, 187, 68, 0.3);
    }

    .liberation-panel h3::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #44bb44;
      margin-right: 6px;
    }

    .liberation-panel h3 {
      color: #66cc66;
    }

    /* Refinements */
    .controls-panel h3 {
      color: #dd6666;
    }

    .time-slider-panel h3 {
      color: #dd6666;
    }

    .detail-section-title {
      color: #dd6666;
    }

    .detail-meta {
      color: #F5DEB3;
      border-bottom-color: rgba(221, 68, 68, 0.2);
    }

    .country-panel {
      border-color: rgba(221, 68, 68, 0.3);
    }

    .detail-description {
      color: #ddd;
    }

    /* Live feed panel */
    .live-feed-panel {
      position: fixed;
      top: 80px;
      left: 20px;
      z-index: 100;
      background: rgba(10, 14, 26, 0.94);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(221, 68, 68, 0.3);
      border-radius: 10px;
      padding: 12px;
      width: 320px;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: 0 4px 24px rgba(0,0,0,0.5);
    }

    .live-feed-panel h3 {
      font-size: 11px;
      text-transform: uppercase;
      color: #dd6666;
      margin-bottom: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .live-feed-panel h3::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #C41E3A;
      margin-right: 6px;
      animation: pulse-live 1.5s infinite;
    }

    .live-event-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(221, 68, 68, 0.1);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .live-event-item:hover {
      background: rgba(221, 68, 68, 0.08);
      border-radius: 4px;
      padding: 8px 6px;
      margin: 0 -6px;
    }

    .live-event-item:last-child {
      border-bottom: none;
    }

    .live-event-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 3px;
    }

    .live-event-severity {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .live-event-severity.sev-1 { background: #ffaa44; }
    .live-event-severity.sev-2 { background: #ff8844; }
    .live-event-severity.sev-3 { background: #ff4444; }
    .live-event-severity.sev-4 { background: #ff0000; animation: pulse-live 1s infinite; }

    .live-event-type {
      font-size: 9px;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.5px;
      padding: 1px 5px;
      border-radius: 3px;
    }

    .live-event-type.type-conflict {
      color: #ff6666;
      background: rgba(255, 68, 68, 0.15);
    }

    .live-event-type.type-protest {
      color: #ffcc44;
      background: rgba(255, 204, 68, 0.15);
    }

    .live-event-type.type-incident {
      color: #44aaff;
      background: rgba(68, 170, 255, 0.15);
    }

    .live-event-location {
      color: #ccc;
      font-weight: 500;
      font-size: 11px;
    }

    .live-event-headline {
      color: #999;
      font-size: 10px;
      line-height: 1.3;
      margin-top: 2px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .live-event-source {
      color: #666;
      font-size: 9px;
      margin-top: 3px;
    }

    .live-feed-panel::-webkit-scrollbar { width: 4px; }
    .live-feed-panel::-webkit-scrollbar-track { background: rgba(221, 68, 68, 0.05); }
    .live-feed-panel::-webkit-scrollbar-thumb { background: rgba(221, 68, 68, 0.3); border-radius: 2px; }

    /* Live event count in status */
    .live-count-badge {
      display: inline-block;
      background: rgba(221, 68, 68, 0.2);
      color: #ff8888;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      margin-left: 6px;
      font-weight: 600;
    }
  </style>
</head>
<body>
<div class="status-bar"></div>
<div class="container">
  <div class="title">
    <a href="/" style="text-decoration:none; color:#ff8888; font-size:12px; display:inline-flex; align-items:center; gap:4px; margin-bottom:8px; opacity:0.7; pointer-events:auto;">← Back to Hub</a>
    <h1 style="display:flex;align-items:center;gap:10px;">LeftistMonitor <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#dd4444;animation:pulse-live 2s infinite;"></span></h1>
    <p>Global Conflict Monitor &mdash; Real-time Tracking</p>
  </div>

  <div class="controls-panel">
    <h3>Display</h3>
    <div class="control-group">
      <button class="toggle-btn active" id="toggle-borders" data-target="borders">Borders</button>
    </div>
    <div class="control-group">
      <button class="toggle-btn active" id="toggle-conflicts" data-target="conflicts">Conflicts</button>
    </div>
    <div class="control-group">
      <button class="toggle-btn active" id="toggle-cities" data-target="cities">Cities</button>
    </div>
    <div class="control-group">
      <button class="toggle-btn active" id="toggle-liberation" data-target="liberation">Liberation</button>
    </div>
    <div class="control-group">
      <button class="toggle-btn active" id="toggle-live-events" data-target="live-events">Live Events</button>
    </div>
    <div class="control-group" style="margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(221, 68, 68, 0.2);">
      <button class="toggle-btn active" id="toggle-auto-rotate" data-target="auto-rotate">Auto-Rotate</button>
    </div>
  </div>

  <!-- Live feed panel -->
  <div class="live-feed-panel" id="live-feed-panel">
    <h3>Live Feed</h3>
    <div id="live-feed-list"></div>
  </div>

  <div class="liberation-panel">
    <h3>Liberation Struggles</h3>
    <div id="liberation-list"></div>
  </div>

  <div class="conflicts-panel">
    <h3>Active Conflicts</h3>
    <div id="conflicts-list"></div>
  </div>

  <div class="time-slider-panel">
    <h3>Timeline</h3>
    <div class="slider-container">
      <button class="play-pause-btn" id="play-pause">▶</button>
      <input type="range" class="time-slider" id="time-slider" min="1900" max="2026" value="2026">
      <div class="year-display" id="year-display">2026</div>
    </div>
    <div class="conflict-count">
      <span id="active-conflict-count">0</span> conflicts active
    </div>
  </div>

  <div class="legend">
    Drag to rotate • Scroll to zoom • Click for details
  </div>

  <div class="detail-panel" id="detail-panel">
    <button class="detail-close" id="detail-close">&times;</button>
    <div id="detail-content"></div>
  </div>

  <div class="country-panel" id="country-panel">
    <button class="country-close" id="country-close">&times;</button>
    <h2 id="country-name"></h2>
    <button class="country-btn" id="country-details-btn">View Country Details →</button>
  </div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.182.0/build/three.module.js"
  }
}
</script>

<script type="module">
import * as THREE from 'three'

// ==================== CONFLICT & LIBERATION DATA ====================

const conflictData = [
  { id: 'ww1', name: 'World War I', type: 'Interstate War', startYear: 1914, endYear: 1918, casualties: 20000000, lat: 48, lng: 8, description: 'The First World War, a global conflict between the Allied Powers and the Central Powers.', sides: [{name: 'Allies', color: 0x4499dd, countries: ['UK', 'France', 'Russia', 'US']}, {name: 'Central Powers', color: 0xdd4444, countries: ['Germany', 'Austria-Hungary', 'Ottoman Empire']}] },
  { id: 'ww2', name: 'World War II', type: 'Interstate War', startYear: 1939, endYear: 1945, casualties: 70000000, lat: 51, lng: 10, description: 'The Second World War, fought between the Allies and the Axis Powers.', sides: [{name: 'Allies', color: 0x4499dd, countries: ['UK', 'US', 'Soviet Union', 'China']}, {name: 'Axis', color: 0xdd4444, countries: ['Germany', 'Italy', 'Japan']}] },
  { id: 'korean', name: 'Korean War', type: 'Interstate War', startYear: 1950, endYear: 1953, casualties: 3000000, lat: 37, lng: 127, description: 'War between North Korea (supported by China and Soviet Union) and South Korea (supported by UN forces led by US).', sides: [{name: 'UN/South Korea', color: 0x4499dd, countries: ['South Korea', 'US', 'UK', 'Canada']}, {name: 'North Korea', color: 0xdd4444, countries: ['North Korea', 'China', 'Soviet Union']}] },
  { id: 'vietnam', name: 'Vietnam War', type: 'Interstate War', startYear: 1955, endYear: 1975, casualties: 3000000, lat: 16, lng: 107, description: 'Conflict between North Vietnam (with Soviet and Chinese support) and South Vietnam (with US support).', sides: [{name: 'South Vietnam/US', color: 0x4499dd, countries: ['South Vietnam', 'US', 'Australia']}, {name: 'North Vietnam', color: 0xdd4444, countries: ['North Vietnam', 'Viet Cong', 'Soviet Union', 'China']}] },
  { id: 'soviet-afghan', name: 'Soviet-Afghan War', type: 'Interstate War', startYear: 1979, endYear: 1989, casualties: 2000000, lat: 34, lng: 69, description: 'Soviet invasion of Afghanistan and subsequent conflict with the Mujahideen resistance.', sides: [{name: 'Soviet Union', color: 0xdd4444, countries: ['Soviet Union']}, {name: 'Mujahideen', color: 0x4499dd, countries: ['Afghanistan', 'US support']}] },
  { id: 'israeli-palestinian', name: 'Israeli-Palestinian Conflict', type: 'Protracted Conflict', startYear: 1948, endYear: 2026, casualties: 500000, lat: 31.95, lng: 35.23, description: 'Decades-long conflict over territory and sovereignty between Israel and Palestinian peoples.', sides: [{name: 'Israel', color: 0xdd4499, countries: ['Israel']}, {name: 'Palestine', color: 0x99dd44, countries: ['Palestine']}] },
  { id: 'iran-iraq', name: 'Iran-Iraq War', type: 'Interstate War', startYear: 1980, endYear: 1988, casualties: 1000000, lat: 33, lng: 44, description: 'War between Iran and Iraq over territorial and religious disputes.', sides: [{name: 'Iraq', color: 0xdd4444, countries: ['Iraq']}, {name: 'Iran', color: 0x4499dd, countries: ['Iran']}] },
  { id: 'gulf-war', name: 'Gulf War', type: 'Interstate War', startYear: 1990, endYear: 1991, casualties: 300000, lat: 29, lng: 47, description: 'Conflict following Iraq\'s invasion of Kuwait, involving a US-led coalition.', sides: [{name: 'Coalition', color: 0x4499dd, countries: ['US', 'UK', 'Saudi Arabia']}, {name: 'Iraq', color: 0xdd4444, countries: ['Iraq']}] },
  { id: 'bosnian', name: 'Bosnian War', type: 'Civil War', startYear: 1992, endYear: 1995, casualties: 100000, lat: 43.8, lng: 18, description: 'Conflict during the breakup of Yugoslavia, with ethnic cleansing and genocide.', sides: [{name: 'Bosniaks', color: 0x4499dd, countries: ['Bosnia', 'Croats']}, {name: 'Serbs', color: 0xdd4444, countries: ['Serbian Republic']}] },
  { id: 'rwandan', name: 'Rwandan Genocide', type: 'Genocide', startYear: 1994, endYear: 1994, casualties: 800000, lat: -1.9, lng: 29.8, description: 'Mass genocide in Rwanda, primarily targeting the Tutsi population.', sides: [{name: 'Hutu extremists', color: 0xdd4444, countries: ['Rwanda']}, {name: 'Tutsis/RPF', color: 0x4499dd, countries: ['Rwanda']}] },
  { id: 'afghanistan-2001', name: 'Afghanistan War', type: 'Interstate War', startYear: 2001, endYear: 2021, casualties: 700000, lat: 34, lng: 67, description: 'US-led invasion and occupation of Afghanistan against Taliban and Al-Qaeda.', sides: [{name: 'US/NATO', color: 0x4499dd, countries: ['US', 'NATO', 'Afghanistan']}, {name: 'Taliban/Al-Qaeda', color: 0xdd4444, countries: ['Afghanistan']}] },
  { id: 'iraq-2003', name: 'Iraq War', type: 'Interstate War', startYear: 2003, endYear: 2011, casualties: 600000, lat: 33, lng: 44, description: 'US-led invasion of Iraq, overthrowing Saddam Hussein\'s government.', sides: [{name: 'Coalition', color: 0x4499dd, countries: ['US', 'UK', 'Iraq']}, {name: 'Insurgents', color: 0xdd4444, countries: ['Iraq', 'Al-Qaeda']}] },
  { id: 'darfur', name: 'Darfur Conflict', type: 'Internal Conflict', startYear: 2003, endYear: 2026, casualties: 400000, lat: 13, lng: 24, description: 'Conflict in Sudan over resources and ethnic tensions, with significant humanitarian crisis.', sides: [{name: 'Sudanese Government', color: 0xdd4444, countries: ['Sudan', 'Janjaweed']}, {name: 'Rebel Groups', color: 0x4499dd, countries: ['Sudan']}] },
  { id: 'syrian', name: 'Syrian Civil War', type: 'Civil War', startYear: 2011, endYear: 2026, casualties: 500000, lat: 34.8, lng: 38.8, description: 'Multi-sided civil war involving government, opposition forces, ISIS, and international powers.', sides: [{name: 'Assad Government', color: 0xdd4444, countries: ['Syria', 'Russia']}, {name: 'Opposition', color: 0x4499dd, countries: ['Syria', 'US']}] },
  { id: 'yemen', name: 'Yemeni Civil War', type: 'Civil War', startYear: 2014, endYear: 2026, casualties: 200000, lat: 15, lng: 48, description: 'Conflict between the Houthi movement and the Saudi-backed government.', sides: [{name: 'Saudi Coalition', color: 0x4499dd, countries: ['Saudi Arabia', 'UAE', 'Yemen']}, {name: 'Houthis', color: 0xdd4444, countries: ['Yemen']}] },
  { id: 'libya', name: 'Libyan Civil War', type: 'Civil War', startYear: 2014, endYear: 2020, casualties: 50000, lat: 27, lng: 17, description: 'Conflict between internationally-recognized government and Haftar\'s Libyan National Army.', sides: [{name: 'GNA', color: 0x4499dd, countries: ['Libya', 'Turkey']}, {name: 'LNA', color: 0xdd4444, countries: ['Libya']}] },
  { id: 'somalia', name: 'Somali Civil War', type: 'Civil War', startYear: 1991, endYear: 2026, casualties: 400000, lat: 5, lng: 46, description: 'Prolonged civil war involving government, militias, pirates, and terrorist groups.', sides: [{name: 'Federal Government', color: 0x4499dd, countries: ['Somalia', 'AMISOM']}, {name: 'Al-Shabaab', color: 0xdd4444, countries: ['Somalia']}] },
  { id: 'congo', name: 'Congo Wars', type: 'Interstate War', startYear: 1996, endYear: 2003, casualties: 3000000, lat: -4, lng: 23, description: 'Two wars in the Democratic Republic of Congo involving multiple regional powers.', sides: [{name: 'DRC Government', color: 0x4499dd, countries: ['DRC', 'Angola', 'Zimbabwe']}, {name: 'Rwandan/Ugandan', color: 0xdd4444, countries: ['Rwanda', 'Uganda']}] },
  { id: 'ukraine', name: 'Ukraine-Russia War', type: 'Interstate War', startYear: 2022, endYear: 2026, casualties: 200000, lat: 48, lng: 35, description: 'Russian invasion of Ukraine following annexation of Crimea and support for separatists.', sides: [{name: 'Ukraine', color: 0x4499dd, countries: ['Ukraine', 'NATO support']}, {name: 'Russia', color: 0xdd4444, countries: ['Russia']}] },
  { id: 'tigray', name: 'Ethiopian Tigray Conflict', type: 'Civil War', startYear: 2020, endYear: 2022, casualties: 100000, lat: 13, lng: 39, description: 'Conflict between Ethiopian federal forces and Tigray People\'s Liberation Front.', sides: [{name: 'Federal Government', color: 0xdd4444, countries: ['Ethiopia']}, {name: 'TPLF', color: 0x4499dd, countries: ['Ethiopia']}] },
  { id: 'myanmar', name: 'Myanmar Civil War', type: 'Civil War', startYear: 2021, endYear: 2026, casualties: 50000, lat: 21, lng: 96, description: 'Conflict between military junta and opposition forces following 2021 coup.', sides: [{name: 'Military Junta', color: 0xdd4444, countries: ['Myanmar']}, {name: 'Opposition/Insurgents', color: 0x4499dd, countries: ['Myanmar']}] },
  { id: 'sudan-2023', name: 'Sudan Civil War', type: 'Civil War', startYear: 2023, endYear: 2026, casualties: 50000, lat: 15.5, lng: 32.5, description: 'Conflict between Sudanese Armed Forces and Rapid Support Forces after military coup.', sides: [{name: 'SAF', color: 0xdd4444, countries: ['Sudan']}, {name: 'RSF', color: 0x4499dd, countries: ['Sudan']}] },
  { id: 'colombia', name: 'Colombian Conflict', type: 'Internal Conflict', startYear: 1964, endYear: 2016, casualties: 260000, lat: 4, lng: -74, description: 'Decades-long conflict between government, FARC guerrillas, and paramilitaries over territory and drugs.', sides: [{name: 'Colombian Government', color: 0x4499dd, countries: ['Colombia', 'US']}, {name: 'FARC/ELN', color: 0xdd4444, countries: ['Colombia']}] },
  { id: 'angola', name: 'Angolan Civil War', type: 'Civil War', startYear: 1975, endYear: 2002, casualties: 500000, lat: -11.2, lng: 17.9, description: 'Civil war between MPLA government and UNITA rebels, with Cold War superpower involvement.', sides: [{name: 'MPLA', color: 0x4499dd, countries: ['Angola', 'Cuba', 'Soviet Union']}, {name: 'UNITA', color: 0xdd4444, countries: ['Angola', 'South Africa']}] },
  { id: 'cambodia', name: 'Cambodian Genocide', type: 'Genocide', startYear: 1975, endYear: 1979, casualties: 2000000, lat: 12.5, lng: 104.9, description: 'Mass genocide by the Khmer Rouge regime killing approximately 2 million people.', sides: [{name: 'Khmer Rouge', color: 0xdd4444, countries: ['Cambodia']}, {name: 'Population', color: 0x4499dd, countries: ['Cambodia']}] },
  { id: 'srilanka', name: 'Sri Lankan Civil War', type: 'Civil War', startYear: 1983, endYear: 2009, casualties: 100000, lat: 7, lng: 80.8, description: 'Conflict between government and Tamil Tigers liberation movement.', sides: [{name: 'Government', color: 0x4499dd, countries: ['Sri Lanka']}, {name: 'LTTE', color: 0xdd4444, countries: ['Sri Lanka']}] },
  { id: 'chechnya', name: 'Chechen Wars', type: 'Internal Conflict', startYear: 1994, endYear: 2009, casualties: 200000, lat: 43.3, lng: 45.7, description: 'Two wars between Russia and Chechen separatists, with major humanitarian costs.', sides: [{name: 'Russia', color: 0xdd4444, countries: ['Russia']}, {name: 'Chechen Separatists', color: 0x4499dd, countries: ['Russia']}] }
]

const liberationStruggles = [
  { id: 'palestine', name: 'Palestine', color: 0x99dd44, lat: 31.95, lng: 35.23, description: 'Palestinian struggle for self-determination and statehood.' },
  { id: 'kurdistan', name: 'Kurdistan', color: 0xddaa44, lat: 37, lng: 44, description: 'Kurdish struggle for autonomy and independence across Turkey, Iraq, Syria, and Iran.' },
  { id: 'kashmir', name: 'Kashmir', color: 0x44ddaa, lat: 34.5, lng: 76.5, description: 'Kashmiri struggle for self-determination between India and Pakistan.' },
  { id: 'tibet', name: 'Tibet', color: 0xdd44aa, lat: 30, lng: 91, description: 'Tibetan independence and autonomy struggle against Chinese control.' },
  { id: 'westsahara', name: 'Western Sahara', color: 0xaadd44, lat: 24.5, lng: -13, description: 'Sahrawi struggle for independence from Moroccan occupation.' },
  { id: 'westpapua', name: 'West Papua', color: 0x44aadd, lat: -3, lng: 133, description: 'West Papuan independence struggle against Indonesian rule.' },
  { id: 'northernireland', name: 'Northern Ireland', color: 0xdddd44, lat: 54.6, lng: -6, description: 'Historical Irish independence struggle; now focused on political self-determination.' },
  { id: 'uyghur', name: 'Uyghur Region', color: 0xdd8844, lat: 42.5, lng: 87, description: 'Uyghur autonomy and cultural rights struggle in Xinjiang, China.' }
]

// Country centroids for conflict arc endpoints
const countryCentroids = {
  '840': { name: 'US', lat: 39, lng: -98 },
  '826': { name: 'UK', lat: 54, lng: -2 },
  '250': { name: 'France', lat: 46, lng: 2 },
  '276': { name: 'Germany', lat: 51, lng: 10 },
  '643': { name: 'Russia', lat: 55, lng: 37 },
  '156': { name: 'China', lat: 35, lng: 104 },
  '392': { name: 'Japan', lat: 36, lng: 138 },
  '356': { name: 'India', lat: 21, lng: 78 },
  '076': { name: 'Brazil', lat: -15, lng: -48 },
  '036': { name: 'Australia', lat: -25, lng: 134 },
  '710': { name: 'South Africa', lat: -29, lng: 24 },
  '818': { name: 'Egypt', lat: 26, lng: 30 },
  '566': { name: 'Nigeria', lat: 9, lng: 8 },
  '404': { name: 'Kenya', lat: -1, lng: 37 },
  '484': { name: 'Mexico', lat: 23, lng: -102 },
  '032': { name: 'Argentina', lat: -34, lng: -64 },
  '170': { name: 'Colombia', lat: 4, lng: -74 },
  '862': { name: 'Venezuela', lat: 7, lng: -66 },
  '792': { name: 'Turkey', lat: 39, lng: 35 },
  '364': { name: 'Iran', lat: 32, lng: 54 },
  '368': { name: 'Iraq', lat: 33, lng: 44 },
  '760': { name: 'Syria', lat: 35, lng: 38 },
  '682': { name: 'Saudi Arabia', lat: 24, lng: 45 },
  '376': { name: 'Israel', lat: 31, lng: 35 },
  '275': { name: 'Palestine', lat: 32, lng: 35 },
  '422': { name: 'Lebanon', lat: 34, lng: 36 },
  '004': { name: 'Afghanistan', lat: 34, lng: 68 },
  '586': { name: 'Pakistan', lat: 30, lng: 70 },
  '804': { name: 'Ukraine', lat: 49, lng: 32 },
  '616': { name: 'Poland', lat: 52, lng: 20 },
  '380': { name: 'Italy', lat: 42, lng: 13 },
  '724': { name: 'Spain', lat: 40, lng: -4 },
  '528': { name: 'Netherlands', lat: 52, lng: 5 },
  '124': { name: 'Canada', lat: 56, lng: -106 },
  '410': { name: 'South Korea', lat: 36, lng: 128 },
  '408': { name: 'North Korea', lat: 40, lng: 127 },
  '704': { name: 'Vietnam', lat: 14, lng: 108 },
  '764': { name: 'Thailand', lat: 15, lng: 101 },
  '104': { name: 'Myanmar', lat: 22, lng: 96 },
  '360': { name: 'Indonesia', lat: -1, lng: 114 },
  '608': { name: 'Philippines', lat: 13, lng: 122 },
  '231': { name: 'Ethiopia', lat: 9, lng: 40 },
  '180': { name: 'DR Congo', lat: -4, lng: 22 },
  '736': { name: 'Sudan', lat: 13, lng: 30 },
  '434': { name: 'Libya', lat: 27, lng: 17 },
  '012': { name: 'Algeria', lat: 28, lng: 2 },
  '504': { name: 'Morocco', lat: 32, lng: -7 },
  '887': { name: 'Yemen', lat: 15, lng: 48 },
  '706': { name: 'Somalia', lat: 5, lng: 46 },
  '646': { name: 'Rwanda', lat: -2, lng: 30 },
  '070': { name: 'Bosnia', lat: 44, lng: 18 },
  '191': { name: 'Croatia', lat: 45, lng: 16 },
  '688': { name: 'Serbia', lat: 44, lng: 21 },
  '152': { name: 'Chile', lat: -35, lng: -71 },
  '604': { name: 'Peru', lat: -10, lng: -75 },
  '218': { name: 'Ecuador', lat: -2, lng: -78 },
  '858': { name: 'Uruguay', lat: -33, lng: -56 },
  '068': { name: 'Bolivia', lat: -17, lng: -64 },
  '320': { name: 'Guatemala', lat: 15, lng: -90 },
  '340': { name: 'Honduras', lat: 15, lng: -86 },
  '222': { name: 'El Salvador', lat: 14, lng: -89 },
  '558': { name: 'Nicaragua', lat: 13, lng: -85 },
  '192': { name: 'Cuba', lat: 22, lng: -78 },
  '332': { name: 'Haiti', lat: 19, lng: -72 },
  '024': { name: 'Angola', lat: -12, lng: 18 },
  '508': { name: 'Mozambique', lat: -18, lng: 36 },
  '116': { name: 'Cambodia', lat: 13, lng: 105 }
}

// ==================== THREE.JS SETUP ====================

const scene = new THREE.Scene()
scene.background = new THREE.Color('#2a1a1a')

const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100)
camera.position.z = 2.8

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false })
renderer.setSize(window.innerWidth, window.innerHeight)
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2))
document.querySelector('.container').appendChild(renderer.domElement)

// ==================== LIGHTING ====================

scene.add(new THREE.AmbientLight(0xffffff, 1.2))
const dl = new THREE.DirectionalLight(0xffffff, 1.0)
dl.position.set(5, 3, 5)
scene.add(dl)

const dl2 = new THREE.DirectionalLight(0x4488cc, 0.4)
dl2.position.set(-5, -3, -5)
scene.add(dl2)

// ==================== GLOBE GROUP (for unified rotation) ====================

const globeGroup = new THREE.Group()
scene.add(globeGroup)

// ==================== GLOBE SPHERE ====================

const globeGeo = new THREE.SphereGeometry(1, 128, 128)
const globeMat = new THREE.MeshPhongMaterial({
  color: 0xffffff,
  shininess: 25,
  specular: 0x333333
})
const globeMesh = new THREE.Mesh(globeGeo, globeMat)
globeGroup.add(globeMesh)

// Load textures
const loader = new THREE.TextureLoader()
loader.load('/globe/earth-blue-marble.jpg', (tex) => {
  globeMat.map = tex
  globeMat.needsUpdate = true
})

loader.load('/globe/earth-topology.png', (tex) => {
  globeMat.bumpMap = tex
  globeMat.bumpScale = 0.015
  globeMat.needsUpdate = true
})

loader.load('/globe/earth-water.png', (tex) => {
  globeMat.specularMap = tex
  globeMat.needsUpdate = true
})

// ==================== ATMOSPHERE ====================

const atmoGeo = new THREE.SphereGeometry(1.02, 64, 64)
const atmoMat = new THREE.MeshBasicMaterial({ color: 0x3388ff, transparent: true, opacity: 0.08, side: THREE.BackSide })
globeGroup.add(new THREE.Mesh(atmoGeo, atmoMat))

// ==================== STARS ====================

const starGeo = new THREE.BufferGeometry()
const starCount = 1000
const positions = new Float32Array(starCount * 3)
for (let i = 0; i < starCount * 3; i += 3) {
  positions[i] = (Math.random() - 0.5) * 100
  positions[i + 1] = (Math.random() - 0.5) * 100
  positions[i + 2] = (Math.random() - 0.5) * 100
}
starGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3))
const starMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1 })
scene.add(new THREE.Points(starGeo, starMat))

// ==================== HELPER FUNCTIONS ====================

const toVec = (lng, lat, r = 1.01) => {
  const phi = (90 - lat) * Math.PI / 180
  const theta = (lng + 180) * Math.PI / 180
  return new THREE.Vector3(-r * Math.sin(phi) * Math.cos(theta), r * Math.cos(phi), r * Math.sin(phi) * Math.sin(theta))
}

const latLngToVec = (lat, lng, r = 1.01) => toVec(lng, lat, r)

// Great circle arc function
const createGreatCircleArc = (lat1, lng1, lat2, lng2, numPoints = 50) => {
  const v1 = latLngToVec(lat1, lng1, 1)
  const v2 = latLngToVec(lat2, lng2, 1)

  const points = []
  for (let i = 0; i <= numPoints; i++) {
    const t = i / numPoints
    const p1 = v1.clone().multiplyScalar(Math.cos(t * Math.PI / 2))
    const p2 = v2.clone().multiplyScalar(Math.sin(t * Math.PI / 2))
    const p = p1.add(p2).normalize()

    // Arc height
    const dist = v1.distanceTo(v2)
    const maxHeight = Math.min(0.15, dist * 0.05)
    const height = maxHeight * Math.sin(t * Math.PI)
    p.multiplyScalar(1 + height)

    points.push(p)
  }
  return points
}

// ==================== COUNTRY BORDERS ====================

const bordersGroup = new THREE.Group()
bordersGroup.name = 'borders'
globeGroup.add(bordersGroup)

const countryPolygonData = []

fetch('/globe/countries-50m.json')
  .then(r => r.json())
  .then(data => {
    const arc2coords = (arc, transform) => {
      let x = 0, y = 0
      return arc.map(p => {
        x += p[0]
        y += p[1]
        return [x * transform.scale[0] + transform.translate[0], y * transform.scale[1] + transform.translate[1]]
      })
    }

    const arcs = data.arcs.map(a => arc2coords(a, data.transform))
    const geos = data.objects.countries.geometries

    const drawRing = (indices, geoObj) => {
      const pts = []
      const coords = []
      indices.forEach(idx => {
        let coordList
        if (idx < 0) { coordList = [...arcs[~idx]].reverse() }
        else { coordList = arcs[idx] }
        coordList.forEach(c => {
          coords.push(c)
          pts.push(toVec(c[0], c[1], 1.002))
        })
      })

      if (pts.length > 1) {
        const g = new THREE.BufferGeometry().setFromPoints(pts)
        const m = new THREE.LineBasicMaterial({ color: 0xdd6666, transparent: true, opacity: 0.3 })
        bordersGroup.add(new THREE.Line(g, m))
      }

      return coords
    }

    geos.forEach((g, idx) => {
      const countryData = {
        id: g.id,
        name: g.properties?.name || 'Unknown',
        arcs: [],
        centroid: { lat: 0, lng: 0 }
      }

      let allCoords = []
      if (g.type === 'Polygon') {
        g.arcs.forEach(ring => {
          const ringCoords = drawRing(ring, g)
          countryData.arcs.push(ringCoords)
          allCoords = allCoords.concat(ringCoords)
        })
      } else if (g.type === 'MultiPolygon') {
        g.arcs.forEach(polygon => {
          polygon.forEach(ring => {
            const ringCoords = drawRing(ring, g)
            countryData.arcs.push(ringCoords)
            allCoords = allCoords.concat(ringCoords)
          })
        })
      }

      // Calculate centroid
      if (allCoords.length > 0) {
        let avgLat = 0, avgLng = 0
        allCoords.forEach(c => {
          avgLng += c[0]
          avgLat += c[1]
        })
        countryData.centroid.lat = avgLat / allCoords.length
        countryData.centroid.lng = avgLng / allCoords.length
      }

      countryPolygonData.push(countryData)
    })
  })
  .catch(e => console.error('Borders failed:', e))

// ==================== CONFLICT MARKERS & ARCS ====================

const conflictsGroup = new THREE.Group()
conflictsGroup.name = 'conflicts'
globeGroup.add(conflictsGroup)

const arcsGroup = new THREE.Group()
arcsGroup.name = 'arcs'
globeGroup.add(arcsGroup)

const conflictMarkers = conflictData.map(conflict => {
  const group = new THREE.Group()
  group.userData = { conflictId: conflict.id, conflict }

  // Pulsing dot
  const dotGeo = new THREE.SphereGeometry(0.015, 16, 16)
  const dotMat = new THREE.MeshBasicMaterial({ color: 0xff4444 })
  const dot = new THREE.Mesh(dotGeo, dotMat)
  group.add(dot)

  // Ring effect
  const ringGeo = new THREE.BufferGeometry()
  const ringPts = []
  for (let i = 0; i <= 32; i++) {
    const angle = (i / 32) * Math.PI * 2
    ringPts.push(new THREE.Vector3(Math.cos(angle) * 0.035, Math.sin(angle) * 0.035, 0))
  }
  ringGeo.setFromPoints(ringPts)
  const ringMat = new THREE.LineBasicMaterial({ color: 0xff4444, transparent: true, opacity: 0.5 })
  const ring = new THREE.Line(ringGeo, ringMat)
  group.add(ring)

  group.userData.dot = dot
  group.userData.ring = ring
  group.userData.pulse = 0

  const pos = toVec(conflict.lng, conflict.lat)
  group.position.copy(pos)

  conflictsGroup.add(group)
  return group
})

function updateConflictArcs(year) {
  // Clear old arcs
  while (arcsGroup.children.length > 0) {
    const child = arcsGroup.children[0]
    if (child.geometry) child.geometry.dispose()
    if (child.material) child.material.dispose()
    arcsGroup.remove(child)
  }

  // Draw new arcs for active conflicts
  const activeConflicts = conflictData.filter(c => c.startYear <= year && year <= c.endYear)

  activeConflicts.forEach(conflict => {
    const conflictPos = { lat: conflict.lat, lng: conflict.lng }

    // Draw arcs for each side
    conflict.sides.forEach((side, sideIdx) => {
      const color = side.color

      side.countries.forEach(countryName => {
        // Find country centroid (simplified: use country centroids map)
        let targetLat = conflictPos.lat
        let targetLng = conflictPos.lng

        // Try to find approximate coordinates for country name
        if (countryName === 'US') { targetLat = 39; targetLng = -98 }
        else if (countryName === 'UK') { targetLat = 54; targetLng = -2 }
        else if (countryName === 'France') { targetLat = 46; targetLng = 2 }
        else if (countryName === 'Russia' || countryName === 'Soviet Union') { targetLat = 55; targetLng = 37 }
        else if (countryName === 'Germany') { targetLat = 51; targetLng = 10 }
        else if (countryName === 'China') { targetLat = 35; targetLng = 104 }
        else if (countryName === 'Japan') { targetLat = 36; targetLng = 138 }
        else if (countryName === 'India') { targetLat = 21; targetLng = 78 }
        else if (countryName === 'Pakistan') { targetLat = 30; targetLng = 70 }
        else if (countryName === 'Iran') { targetLat = 32; targetLng = 54 }
        else if (countryName === 'Iraq') { targetLat = 33; targetLng = 44 }
        else if (countryName === 'Syria') { targetLat = 35; targetLng = 38 }
        else if (countryName === 'Turkey') { targetLat = 39; targetLng = 35 }
        else if (countryName === 'Vietnam' || countryName === 'South Vietnam' || countryName === 'North Vietnam') { targetLat = 16; targetLng = 107 }
        else if (countryName === 'South Korea') { targetLat = 36; targetLng = 128 }
        else if (countryName === 'North Korea') { targetLat = 40; targetLng = 127 }
        else if (countryName === 'Canada') { targetLat = 56; targetLng = -106 }
        else if (countryName === 'Australia') { targetLat = -25; targetLng = 134 }
        else if (countryName === 'UK') { targetLat = 54; targetLng = -2 }
        else if (countryName === 'Egypt') { targetLat = 26; targetLng = 30 }
        else if (countryName === 'Saudi Arabia') { targetLat = 24; targetLng = 45 }
        else if (countryName === 'Yemen') { targetLat = 15; targetLng = 48 }
        else if (countryName === 'Sudan') { targetLat = 15; targetLng = 30 }
        else if (countryName === 'Afghanistan') { targetLat = 34; targetLng = 68 }
        else if (countryName === 'Angola') { targetLat = -12; targetLng = 18 }
        else if (countryName === 'Rwanda') { targetLat = -2; targetLng = 30 }
        else if (countryName === 'DRC') { targetLat = -4; targetLng = 22 }
        else if (countryName === 'Colombia') { targetLat = 4; targetLng = -74 }
        else if (countryName === 'Ukraine') { targetLat = 49; targetLng = 32 }

        // Create arc
        const arcPoints = createGreatCircleArc(conflictPos.lat, conflictPos.lng, targetLat, targetLng, 40)

        if (arcPoints.length > 1) {
          const arcGeo = new THREE.BufferGeometry().setFromPoints(arcPoints)
          const arcMat = new THREE.LineBasicMaterial({
            color: color,
            transparent: true,
            opacity: 0.4,
            linewidth: 2
          })
          const arcLine = new THREE.Line(arcGeo, arcMat)
          arcLine.userData = { conflictId: conflict.id, color, sideIdx }
          arcsGroup.add(arcLine)
        }
      })
    })
  })
}

// ==================== LIBERATION MARKERS ====================

const liberationGroup = new THREE.Group()
liberationGroup.name = 'liberation'
globeGroup.add(liberationGroup)

const liberationMarkers = liberationStruggles.map(struggle => {
  const group = new THREE.Group()
  group.userData = { struggleId: struggle.id, struggle }

  // Larger pulsing dot
  const dotGeo = new THREE.SphereGeometry(0.018, 16, 16)
  const dotMat = new THREE.MeshBasicMaterial({ color: struggle.color })
  const dot = new THREE.Mesh(dotGeo, dotMat)
  group.add(dot)

  // Outer ring
  const ringGeo = new THREE.BufferGeometry()
  const ringPts = []
  for (let i = 0; i <= 32; i++) {
    const angle = (i / 32) * Math.PI * 2
    ringPts.push(new THREE.Vector3(Math.cos(angle) * 0.05, Math.sin(angle) * 0.05, 0))
  }
  ringGeo.setFromPoints(ringPts)
  const ringMat = new THREE.LineBasicMaterial({ color: struggle.color, transparent: true, opacity: 0.3 })
  const ring = new THREE.Line(ringGeo, ringMat)
  group.add(ring)

  group.userData.dot = dot
  group.userData.ring = ring
  group.userData.pulse = 0

  const pos = toVec(struggle.lng, struggle.lat)
  group.position.copy(pos)

  liberationGroup.add(group)
  return group
})

// ==================== CITY MARKERS ====================

const citiesData = [
  { name: 'Washington DC', lat: 38.9, lng: -77.0 },
  { name: 'London', lat: 51.5, lng: -0.1 },
  { name: 'Paris', lat: 48.9, lng: 2.4 },
  { name: 'Berlin', lat: 52.5, lng: 13.4 },
  { name: 'Moscow', lat: 55.8, lng: 37.6 },
  { name: 'Tokyo', lat: 35.7, lng: 139.7 },
  { name: 'Beijing', lat: 39.9, lng: 116.4 },
  { name: 'New Delhi', lat: 28.6, lng: 77.2 },
  { name: 'Cairo', lat: 30.0, lng: 31.2 },
  { name: 'Sydney', lat: -33.9, lng: 151.2 },
  { name: 'São Paulo', lat: -23.5, lng: -46.6 },
  { name: 'Mexico City', lat: 19.4, lng: -99.1 },
  { name: 'Johannesburg', lat: -26.2, lng: 28.0 },
  { name: 'Istanbul', lat: 41.0, lng: 28.9 },
  { name: 'Bangkok', lat: 13.7, lng: 100.5 },
  { name: 'Hong Kong', lat: 22.3, lng: 114.2 },
  { name: 'Singapore', lat: 1.4, lng: 103.8 },
  { name: 'Dubai', lat: 25.2, lng: 55.3 },
  { name: 'Mumbai', lat: 19.1, lng: 72.9 },
  { name: 'Seoul', lat: 37.6, lng: 127.0 },
  { name: 'Manila', lat: 14.6, lng: 121.0 },
  { name: 'Jakarta', lat: -6.2, lng: 106.8 },
  { name: 'Lima', lat: -12.0, lng: -77.0 },
  { name: 'Buenos Aires', lat: -34.6, lng: -58.4 },
  { name: 'Toronto', lat: 43.7, lng: -79.4 },
  { name: 'Vancouver', lat: 49.3, lng: -123.1 },
  { name: 'Chicago', lat: 41.9, lng: -87.6 },
  { name: 'Los Angeles', lat: 34.1, lng: -118.2 },
  { name: 'San Francisco', lat: 37.8, lng: -122.4 },
  { name: 'Boston', lat: 42.4, lng: -71.1 },
  { name: 'Madrid', lat: 40.4, lng: -3.7 },
  { name: 'Rome', lat: 41.9, lng: 12.5 },
  { name: 'Amsterdam', lat: 52.4, lng: 4.9 },
  { name: 'Brussels', lat: 50.8, lng: 4.4 },
  { name: 'Vienna', lat: 48.2, lng: 16.4 },
  { name: 'Prague', lat: 50.1, lng: 14.4 },
  { name: 'Warsaw', lat: 52.2, lng: 21.0 },
  { name: 'Athens', lat: 37.9, lng: 23.7 },
  { name: 'Tel Aviv', lat: 32.1, lng: 34.8 },
  { name: 'Beirut', lat: 33.8, lng: 35.5 },
  { name: 'Baghdad', lat: 33.3, lng: 44.4 },
  { name: 'Tehran', lat: 35.7, lng: 51.4 },
  { name: 'Riyadh', lat: 24.8, lng: 46.7 },
  { name: 'Kuwait City', lat: 29.4, lng: 47.9 },
  { name: 'Doha', lat: 25.3, lng: 51.5 },
  { name: 'Abuja', lat: 9.1, lng: 7.5 },
  { name: 'Lagos', lat: 6.5, lng: 3.4 },
  { name: 'Nairobi', lat: -1.3, lng: 36.8 },
  { name: 'Cape Town', lat: -33.9, lng: 18.4 }
]

const citiesGroup = new THREE.Group()
citiesGroup.name = 'cities'
globeGroup.add(citiesGroup)

citiesData.forEach(city => {
  const dotGeo = new THREE.SphereGeometry(0.008, 8, 8)
  const dotMat = new THREE.MeshBasicMaterial({ color: 0xffffff })
  const dot = new THREE.Mesh(dotGeo, dotMat)
  const pos = toVec(city.lng, city.lat)
  dot.position.copy(pos)
  citiesGroup.add(dot)
})

// ==================== INTERACTION STATE ====================

let drag = false
let prevX = 0
let prevY = 0
let rotX = 0.3
let rotY = 0
let autoRotate = true
let currentYear = 2026
let isPlaying = false
let selectedCountry = null

const visibility = {
  borders: true,
  conflicts: true,
  cities: true,
  liberation: true
}

// ==================== RAYCASTING & COUNTRY SELECTION ====================

const raycaster = new THREE.Raycaster()
const mouse = new THREE.Vector2()

function pointInPolygon(point, polygon) {
  let inside = false
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i][0], yi = polygon[i][1]
    const xj = polygon[j][0], yj = polygon[j][1]

    const intersect = ((yi > point[1]) !== (yj > point[1])) && (point[0] < (xj - xi) * (point[1] - yi) / (yj - yi) + xi)
    if (intersect) inside = !inside
  }
  return inside
}

function vec3ToLatLng(vec) {
  vec = vec.normalize()
  const lat = Math.asin(vec.y) * 180 / Math.PI
  const lng = Math.atan2(vec.z, -vec.x) * 180 / Math.PI
  return { lat, lng }
}

function findCountryAtPoint(lat, lng) {
  const point = [lng, lat]
  for (const country of countryPolygonData) {
    for (const polygon of country.arcs) {
      if (pointInPolygon(point, polygon)) {
        return country
      }
    }
  }
  return null
}

// ==================== EVENT LISTENERS ====================

// Pointer events (Safari + Chrome + Firefox)
renderer.domElement.addEventListener('pointerdown', (e) => {
  drag = true
  prevX = e.clientX
  prevY = e.clientY
  autoRotate = false
  updateAutoRotateButton()
})

renderer.domElement.addEventListener('pointermove', (e) => {
  if (!drag) return
  rotY += (e.clientX - prevX) * 0.005
  rotX += (e.clientY - prevY) * 0.005
  rotX = Math.max(-1.5, Math.min(1.5, rotX))
  prevX = e.clientX
  prevY = e.clientY
})

renderer.domElement.addEventListener('pointerup', (e) => {
  drag = false

  // Check for click (small movement)
  if (Math.abs(e.clientX - prevX) < 10 && Math.abs(e.clientY - prevY) < 10) {
    handleGlobeClick(e)
  }
})

// Touch events
renderer.domElement.addEventListener('touchstart', (e) => {
  drag = true
  prevX = e.touches[0].clientX
  prevY = e.touches[0].clientY
  autoRotate = false
  updateAutoRotateButton()
})

renderer.domElement.addEventListener('touchmove', (e) => {
  if (!drag) return
  e.preventDefault()
  rotY += (e.touches[0].clientX - prevX) * 0.005
  rotX += (e.touches[0].clientY - prevY) * 0.005
  rotX = Math.max(-1.5, Math.min(1.5, rotX))
  prevX = e.touches[0].clientX
  prevY = e.touches[0].clientY
}, { passive: false })

renderer.domElement.addEventListener('touchend', () => {
  drag = false
})

// Scroll zoom
renderer.domElement.addEventListener('wheel', (e) => {
  e.preventDefault()
  camera.position.z = Math.max(1.5, Math.min(5, camera.position.z + e.deltaY * 0.001))
}, { passive: false })

// Resize
let resizeTimeout
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout)
  resizeTimeout = setTimeout(() => {
    camera.aspect = window.innerWidth / window.innerHeight
    camera.updateProjectionMatrix()
    renderer.setSize(window.innerWidth, window.innerHeight)
  }, 100)
})

// ==================== GLOBE CLICK HANDLING ====================

function handleGlobeClick(event) {
  mouse.x = (event.clientX / window.innerWidth) * 2 - 1
  mouse.y = -(event.clientY / window.innerHeight) * 2 + 1

  raycaster.setFromCamera(mouse, camera)

  // Check intersection with globe
  const sphereIntersects = raycaster.intersectObject(globeMesh)

  if (sphereIntersects.length > 0) {
    const point = sphereIntersects[0].point
    const latLng = vec3ToLatLng(point)
    const country = findCountryAtPoint(latLng.lat, latLng.lng)

    if (country) {
      showCountryPanel(country)
    }
  }
}

// ==================== UI CONTROLS ====================

const toggleBordersBtn = document.getElementById('toggle-borders')
const toggleConflictsBtn = document.getElementById('toggle-conflicts')
const toggleCitiesBtn = document.getElementById('toggle-cities')
const toggleLiberationBtn = document.getElementById('toggle-liberation')
const toggleAutoRotateBtn = document.getElementById('toggle-auto-rotate')
const timeSlider = document.getElementById('time-slider')
const yearDisplay = document.getElementById('year-display')
const playPauseBtn = document.getElementById('play-pause')
const detailPanel = document.getElementById('detail-panel')
const detailClose = document.getElementById('detail-close')
const detailContent = document.getElementById('detail-content')
const conflictsList = document.getElementById('conflicts-list')
const liberationList = document.getElementById('liberation-list')
const activeConflictCount = document.getElementById('active-conflict-count')
const countryPanel = document.getElementById('country-panel')
const countryClose = document.getElementById('country-close')
const countryName = document.getElementById('country-name')
const countryDetailsBtn = document.getElementById('country-details-btn')

function updateAutoRotateButton() {
  if (autoRotate) {
    toggleAutoRotateBtn.classList.add('active')
  } else {
    toggleAutoRotateBtn.classList.remove('active')
  }
}

toggleBordersBtn.addEventListener('click', () => {
  visibility.borders = !visibility.borders
  bordersGroup.visible = visibility.borders
  toggleBordersBtn.classList.toggle('active')
})

toggleConflictsBtn.addEventListener('click', () => {
  visibility.conflicts = !visibility.conflicts
  conflictsGroup.visible = visibility.conflicts
  toggleConflictsBtn.classList.toggle('active')
})

toggleCitiesBtn.addEventListener('click', () => {
  visibility.cities = !visibility.cities
  citiesGroup.visible = visibility.cities
  toggleCitiesBtn.classList.toggle('active')
})

toggleLiberationBtn.addEventListener('click', () => {
  visibility.liberation = !visibility.liberation
  liberationGroup.visible = visibility.liberation
  toggleLiberationBtn.classList.toggle('active')
})

toggleAutoRotateBtn.addEventListener('click', () => {
  autoRotate = !autoRotate
  updateAutoRotateButton()
})

// ==================== TIMELINE ====================

timeSlider.addEventListener('input', (e) => {
  currentYear = parseInt(e.target.value)
  yearDisplay.textContent = currentYear
  updateConflictsList()
  updateConflictArcs(currentYear)
})

playPauseBtn.addEventListener('click', () => {
  isPlaying = !isPlaying
  playPauseBtn.textContent = isPlaying ? '⏸' : '▶'
})

function updateConflictsList() {
  const activeConflicts = conflictData.filter(c => c.startYear <= currentYear && currentYear <= c.endYear)
  activeConflictCount.textContent = activeConflicts.length

  conflictsList.innerHTML = ''
  activeConflicts.forEach(conflict => {
    const item = document.createElement('div')
    item.className = 'conflict-item'
    item.innerHTML = `
      <div class="conflict-dots">
        <div class="conflict-dot" style="background: ${new THREE.Color(conflict.sides[0].color).getStyle()}"></div>
        <div class="conflict-dot" style="background: ${new THREE.Color(conflict.sides[1].color).getStyle()}"></div>
      </div>
      <div class="conflict-info">
        <div class="conflict-name">${conflict.name}</div>
        <div class="conflict-years">${conflict.startYear}-${conflict.endYear}</div>
      </div>
    `
    item.addEventListener('click', () => showConflictDetail(conflict))
    conflictsList.appendChild(item)
  })

  // Update marker visibility
  conflictMarkers.forEach(marker => {
    const conflictId = marker.userData.conflictId
    const conflict = conflictData.find(c => c.id === conflictId)
    if (conflict) {
      const isActive = conflict.startYear <= currentYear && currentYear <= conflict.endYear
      marker.visible = isActive
    }
  })
}

// ==================== LIBERATION PANEL ====================

liberationList.innerHTML = ''
liberationStruggles.forEach(struggle => {
  const item = document.createElement('div')
  item.className = 'liberation-item'
  item.innerHTML = `
    <div class="liberation-dot" style="background: ${new THREE.Color(struggle.color).getStyle()}"></div>
    <div>${struggle.name}</div>
  `
  item.addEventListener('click', () => {
    detailPanel.classList.add('active')
    detailContent.innerHTML = `
      <div class="detail-title">${struggle.name}</div>
      <div class="detail-description">${struggle.description}</div>
    `
  })
  liberationList.appendChild(item)
})

// ==================== DETAIL PANEL ====================

function showConflictDetail(conflict) {
  detailPanel.classList.add('active')
  const color1 = new THREE.Color(conflict.sides[0].color).getStyle()
  const color2 = new THREE.Color(conflict.sides[1].color).getStyle()

  detailContent.innerHTML = `
    <div class="detail-title">${conflict.name}</div>
    <div class="detail-meta">
      <div><strong>Type:</strong> ${conflict.type}</div>
      <div><strong>Period:</strong> ${conflict.startYear}-${conflict.endYear}</div>
      <div><strong>Est. Casualties:</strong> ${conflict.casualties.toLocaleString()}</div>
    </div>
    <div class="detail-section-title">Sides</div>
    <div class="detail-side">
      <div class="detail-side-dot" style="background: ${color1}"></div>
      <div class="detail-side-text">
        <div class="detail-side-name">${conflict.sides[0].name}</div>
        <div class="detail-side-countries">${conflict.sides[0].countries.join(', ')}</div>
      </div>
    </div>
    <div class="detail-side">
      <div class="detail-side-dot" style="background: ${color2}"></div>
      <div class="detail-side-text">
        <div class="detail-side-name">${conflict.sides[1].name}</div>
        <div class="detail-side-countries">${conflict.sides[1].countries.join(', ')}</div>
      </div>
    </div>
    <div class="detail-section-title">Overview</div>
    <div class="detail-description">${conflict.description}</div>
  `
}

detailClose.addEventListener('click', () => {
  detailPanel.classList.remove('active')
})

detailPanel.addEventListener('click', (e) => {
  if (e.target === detailPanel) {
    detailPanel.classList.remove('active')
  }
})

// ==================== COUNTRY PANEL ====================

function showCountryPanel(country) {
  selectedCountry = country
  countryName.textContent = country.name
  countryPanel.classList.add('active')

  countryDetailsBtn.onclick = () => {
    const path = `/country/${country.id}`
    if (window.parent !== window) {
      window.parent.postMessage({ type: 'navigate', path }, '*')
    } else {
      window.location.href = path
    }
  }
}

countryClose.addEventListener('click', () => {
  countryPanel.classList.remove('active')
  selectedCountry = null
})

// ==================== LIVE EVENTS LAYER ====================

const liveEventsGroup = new THREE.Group()
liveEventsGroup.name = 'live-events'
globeGroup.add(liveEventsGroup)

let liveEventMarkers = []
let liveEventsData = []
let showLiveEvents = true

async function fetchLiveEvents() {
  try {
    const res = await fetch('/api/v1/live/events?limit=635')
    const data = await res.json()
    liveEventsData = data.markers || []
    renderLiveMarkers()
    renderLiveFeed()
    console.log(`Loaded ${liveEventsData.length} live events`)
  } catch (e) {
    console.warn('Could not load live events:', e)
  }
}

function renderLiveMarkers() {
  // Clear old
  while (liveEventsGroup.children.length > 0) {
    const child = liveEventsGroup.children[0]
    if (child.geometry) child.geometry.dispose()
    if (child.material) child.material.dispose()
    liveEventsGroup.remove(child)
  }
  liveEventMarkers = []

  liveEventsData.forEach((evt, i) => {
    const [lat, lng] = evt.position || [0, 0]
    if (!lat && !lng) return

    const group = new THREE.Group()
    group.userData = { eventId: evt.id, event: evt }

    // Color by type
    let color = 0xff6644
    if (evt.type === 'conflict') color = 0xff4444
    else if (evt.type === 'protest') color = 0xffcc44
    else if (evt.type === 'incident') color = 0x44aaff

    // Size by severity
    const sevScale = 0.006 + (evt.severity || 1) * 0.003

    // Small pulsing dot
    const dotGeo = new THREE.SphereGeometry(sevScale, 8, 8)
    const dotMat = new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.9 })
    const dot = new THREE.Mesh(dotGeo, dotMat)
    group.add(dot)

    // Outer glow ring
    const ringGeo = new THREE.BufferGeometry()
    const ringPts = []
    const ringRadius = sevScale * 3
    for (let j = 0; j <= 20; j++) {
      const angle = (j / 20) * Math.PI * 2
      ringPts.push(new THREE.Vector3(Math.cos(angle) * ringRadius, Math.sin(angle) * ringRadius, 0))
    }
    ringGeo.setFromPoints(ringPts)
    const ringMat = new THREE.LineBasicMaterial({ color, transparent: true, opacity: 0.3 })
    const ring = new THREE.Line(ringGeo, ringMat)
    group.add(ring)

    group.userData.dot = dot
    group.userData.ring = ring
    group.userData.pulse = Math.random() * Math.PI * 2  // Random phase offset

    const pos = toVec(lng, lat)
    group.position.copy(pos)
    group.lookAt(new THREE.Vector3(0, 0, 0))

    liveEventsGroup.add(group)
    liveEventMarkers.push(group)
  })
}

function renderLiveFeed() {
  const feedList = document.getElementById('live-feed-list')
  if (!feedList) return

  // Sort by severity (highest first), then relevance
  const sorted = [...liveEventsData].sort((a, b) => {
    if (b.severity !== a.severity) return b.severity - a.severity
    return (b.relevanceScore || 0) - (a.relevanceScore || 0)
  })

  const topEvents = sorted.slice(0, 30)

  feedList.innerHTML = topEvents.map(evt => {
    const typeClass = `type-${evt.type || 'incident'}`
    const sevClass = `sev-${evt.severity || 1}`
    return `
      <div class="live-event-item" data-lat="${(evt.position||[])[0]||0}" data-lng="${(evt.position||[])[1]||0}">
        <div class="live-event-header">
          <span class="live-event-severity ${sevClass}"></span>
          <span class="live-event-type ${typeClass}">${evt.type || 'event'}</span>
          <span class="live-event-location">${evt.location || ''}, ${evt.country || ''}</span>
        </div>
        <div class="live-event-headline">${evt.headline || ''}</div>
        <div class="live-event-source">${evt.source || ''}</div>
      </div>
    `
  }).join('')

  // Update the panel title with count
  const panel = document.getElementById('live-feed-panel')
  if (panel) {
    const h3 = panel.querySelector('h3')
    if (h3) h3.innerHTML = `Live Feed <span class="live-count-badge">${liveEventsData.length}</span>`
  }

  // Click to fly to location
  feedList.querySelectorAll('.live-event-item').forEach(item => {
    item.addEventListener('click', () => {
      const lat = parseFloat(item.dataset.lat)
      const lng = parseFloat(item.dataset.lng)
      if (lat && lng) {
        const targetRotY = -(lng * Math.PI / 180) - Math.PI / 2
        const targetRotX = lat * Math.PI / 180
        rotY = targetRotY
        rotX = targetRotX
        autoRotate = false
        updateAutoRotateButton()
      }
    })
  })
}

// Toggle live events button
document.getElementById('toggle-live-events')?.addEventListener('click', function() {
  showLiveEvents = !showLiveEvents
  liveEventsGroup.visible = showLiveEvents
  const panel = document.getElementById('live-feed-panel')
  if (panel) panel.style.display = showLiveEvents ? 'block' : 'none'
  this.classList.toggle('active', showLiveEvents)
})

// Fetch live events on load
fetchLiveEvents()

// ==================== ANIMATION LOOP ====================

function animate() {
  requestAnimationFrame(animate)

  // Auto-rotation
  if (autoRotate && !drag) {
    rotY += 0.0005
  }

  // Timeline animation
  if (isPlaying) {
    currentYear += 0.5
    if (currentYear > 2026) currentYear = 1900
    timeSlider.value = Math.floor(currentYear)
    yearDisplay.textContent = Math.floor(currentYear)
    updateConflictsList()
    updateConflictArcs(currentYear)
  }

  // Apply rotation to globe group
  globeGroup.rotation.set(rotX, rotY, 0)

  // Pulse conflict markers
  conflictMarkers.forEach(marker => {
    if (marker.visible) {
      marker.userData.pulse = (marker.userData.pulse + 0.03) % (Math.PI * 2)
      const scale = 1 + Math.sin(marker.userData.pulse) * 0.3
      marker.userData.dot.scale.set(scale, scale, scale)
      marker.userData.ring.material.opacity = 0.5 + Math.sin(marker.userData.pulse) * 0.3
    }
  })

  // Pulse liberation markers
  liberationMarkers.forEach(marker => {
    if (marker.visible) {
      marker.userData.pulse = (marker.userData.pulse + 0.02) % (Math.PI * 2)
      const scale = 1 + Math.sin(marker.userData.pulse) * 0.2
      marker.userData.dot.scale.set(scale, scale, scale)
      marker.userData.ring.material.opacity = 0.3 + Math.sin(marker.userData.pulse) * 0.2
    }
  })

  // Pulse live event markers
  liveEventMarkers.forEach(marker => {
    if (marker.visible) {
      marker.userData.pulse = (marker.userData.pulse + 0.04) % (Math.PI * 2)
      const sev = marker.userData.event?.severity || 1
      const scale = 1 + Math.sin(marker.userData.pulse) * (0.2 + sev * 0.15)
      marker.userData.dot.scale.set(scale, scale, scale)
      marker.userData.ring.material.opacity = 0.2 + Math.sin(marker.userData.pulse) * 0.25
    }
  })

  renderer.render(scene, camera)
}

// Initialize
updateConflictsList()
updateConflictArcs(currentYear)
animate()
</script>

</body>
</html>
